---
bibliography: references.bib
---

# Введение в `quarto`

`quarto` --- это публикационная система с открытым исходным кодом, которая имеет очень хорошую интеграцию с R и RStudio и является продолжением важнейшего для R-комьюнити пакета `rmarkdown`. `quarto` позволяет делать документы, презентации, веб-страницы и большие сайты, а в связке с пакетом `shiny` еще и интерактивные приложения. Все это делается в едином формате, который позволяет интегрировать код на R, Python, Julia, Observable и некоторые другие. Такая интеграция позволяет делать интерактивные документы и веб-сайты, в которых всё --- графики, таблицы и списки литературы --- обновляются одним нажатием кнопки на основе обновленных данных. Также создатели `quarto` снабдили его [подробнейшим сайтом](https://quarto.org/) с материалами, объясняющими самые разные аспекты создания документов в `quarto`. Кроме того, рекомендую следующие видео Мине Четинкая-Рандел:

- [Get started with Quarto](https://www.youtube.com/watch?v=_f3latmOhew)
- [Quarto for Academics](https://www.youtube.com/watch?v=EbAAmrB0luA)

`quarto`-документы по своей сути сильно напоминают jupyter-ноутбуки. Jupyter-ноутбуки тоже представляют собой фрагменты кода перемешанные с markdown разметкой, в которых каждый фрагмент кода можно при желании запустить. Отличие заключается в том, что `quarto`-документы хотя и предоставляют запустить каждый фрагмент в текущей сессии, однако чаще всего их компилируют от начала до конца в новой сессии (т. е. переменные, которые пользователь создал в текущей сессии никак не влияют на результат). В R тоже есть ноутбуки (File \> New File \> R Notebook).

## Установка `quarto`

Для установки `quarto` нужно скачать установшик [с этой страницы](https://quarto.org/docs/get-started/), а в RStudio следует установить пакет `quarto`:

```{r}
#| eval: false

install.packages("quarto")
```

После этого можно пойти в меню Rstudio File \> New File \> Quarto Document или ткнуть на крайне левую иконку New File и выбрать из выпадающего списка Quarto Document. После этого откроется окошко, где можно набрать заголовок и автора документа. Эти поля можно не заполнять, а исправить потом в самом документе.

![](images/09_01_creation.png){fig-align="center" width="30%"}

## Режимы Source / Visual

В публикационных системах достаточно давно есть противостояние между разными системами. Одни обычно описывают акронимом [WYSIWYG](https://en.wikipedia.org/wiki/WYSIWYG) (what you see is what you get). В них пользователь набирает и редактирует документ в том виде, в каком он потом, согласно ожиданиям пользователя, будет напечатан или отображен. В качестве примеров такой системы можно привести распространенные редакторы MS Word, LibreOffice или облачные Google Documents. Альтернативой являются компилируемые системы, в которых документ создается при помощи некоторых стандартизованных кодовых вставок, которые кодируют желаемое форматирование для компилятора. Примером такой системы является $\LaTeX$, Markdown и другие. Изначально система `Rmarkdown` предполагала создание документов второго рода, однако при разработке `quarto` в RStudio была добавлена WYSIWYG панель. Между понелями можно переключаются кнопками Source и Visual в левом верхнем углу. Мы в наших материалах будем использовать вкладку Source. Важно отметить, что несмотря на WYSIWYG вкладку документы все равно нужно компилировать нажатием кнопки Render с синей стрелочкой. Некоторые операции сильно удобнее делать в WYSIWYG вкладке, например, вставлять символы и эмодзи, редактировать таблицы и много другое, --- все это изложено в [отдельном разделе](https://quarto.org/docs/visual-editor/) документации `quarto`.

::: {#fig-modes layout-ncol="2"}
![](images/09_02_visual_mode.png)

![](images/09_03_source_mode.png)

Разные виды панелей
:::

## Структура `quarto`-документов

Стандартное расширение `quarto`-документов --- `.qmd`. Все `quarto`-документы могут содержать один из трех элементов:

-   расширенную markdown-разметку при помощи которой пишутся текстовые блоки
-   фрагменты кода (в том числе и на языках отличных от R)
-   `yaml`-шапка, в которой хранится основные метаданные и настройки документа. Начало и конец `yaml`-шапки отделены тремя минусами `---`.

Далее мы рассмотрим все эти элементы.

## Расширенная markdown-разметка

Вот примеры форматирования текста.

+---------------------------------------------------+---------------------------------------------------------+
| markdown-разметка                                 | Результат                                               |
+===================================================+=========================================================+
| ```markdown                                       |                                                         |
| # Заголовок 1 уровня                              | # Заголовок 1 уровня {.heading-output .unnumbered}      |
| ```                                               |                                                         |
+---------------------------------------------------+---------------------------------------------------------+
| ```markdown                                       |                                                         |
| ## Заголовок 2 уровня                             | ## Заголовок 2 уровня {.heading-output .unnumbered}     |
| ```                                               |                                                         |
+---------------------------------------------------+---------------------------------------------------------+
| ```markdown                                       |                                                         |
| ### Заголовок 3 уровня                            | ### Заголовок 3 уровня {.heading-output .unnumbered}    |
| ```                                               |                                                         |
+---------------------------------------------------+---------------------------------------------------------+
| ```markdown                                       |                                                         |
| #### Заголовок 1 уровня                           | #### Заголовок 4 уровня {.heading-output .unnumbered}   |
| ```                                               |                                                         |
+---------------------------------------------------+---------------------------------------------------------+
| ```markdown                                       |                                                         |
| ##### Заголовок 5 уровня                          | ##### Заголовок 5 уровня {.heading-output .unnumbered}  |
| ```                                               |                                                         |
+---------------------------------------------------+---------------------------------------------------------+
| ```markdown                                       |                                                         |
| ###### Заголовок 6 уровня                         | ###### Заголовок 6 уровня {.heading-output .unnumbered} |
| ```                                               |                                                         |
+---------------------------------------------------+---------------------------------------------------------+
| ```markdown                                       |                                                         |
| *курсив*, **полужирный**, ***полужирный курсив*** | *курсив*, **полужирный**, ***полужирный курсив***       |
| ```                                               |                                                         |
+---------------------------------------------------+---------------------------------------------------------+
| ```markdown                                       |                                                         |
| верхний индекс^2^ / нижний индекс~2~              | верхний индекс^2^ / нижний индекс~2~                    |
| ```                                               |                                                         |
+---------------------------------------------------+---------------------------------------------------------+
| ```markdown                                       |                                                         |
| ~~вычеркивание~~                                  | ~~вычеркивание~~                                        |
| ```                                               |                                                         |
+---------------------------------------------------+---------------------------------------------------------+
| ```markdown                                       |                                                         |
| `фрагмент кода`                                   | `фрагмент кода`                                         |
| ```                                               |                                                         |
+---------------------------------------------------+---------------------------------------------------------+
| ```markdown                                       |                                                         |
| ссылка <https://lib.ru/>                          | ссылка <https://lib.ru/>                                |
| ```                                               |                                                         |
+---------------------------------------------------+---------------------------------------------------------+
| ```markdown                                       |                                                         |
| [другая ссылка](https://lib.ru/)                  | [другая ссылка](https://lib.ru/)                        |
| ```                                               |                                                         |
+---------------------------------------------------+---------------------------------------------------------+
| ```markdown                                       |                                                         |
| [подчеркивание]{.underline}                       | [подчеркивание]{.underline}                             |
| ```                                               |                                                         |
+---------------------------------------------------+---------------------------------------------------------+
| ```markdown                                       |                                                         |
| [малые прописные]{.smallcaps}                     | [малые прописные]{.smallcaps}                           |
| ```                                               |                                                         |
+---------------------------------------------------+---------------------------------------------------------+
| ```markdown                                       |                                                         |
| - список                                          | -   список                                              |
| - элементов                                       | -   элементов                                           |
|         - вложенный список                        |     -   вложенный список                                |
|         - из двух элементов                       |     -   из двух элементов                               |
| - еще элемент                                     | -   еще элемент                                         |
| ```                                               |                                                         |
+---------------------------------------------------+---------------------------------------------------------+
| ```markdown                                       |                                                         |
| - [] список                                       | - [] список                                             |
| - [x] задач                                       | - [x] задач                                             |
| ```                                               |                                                         |
+---------------------------------------------------+---------------------------------------------------------+
| ```markdown                                       |                                                         |
| > Отдельный блок для длинных цитат                | > Отдельный блок для длинных цитат                      |
| ```                                               |                                                         |
+---------------------------------------------------+---------------------------------------------------------+
| ```markdown                                       |                                                         |
| Сноска[^1] и еще одна с названием[^mynote].       | Сноска[^1] и еще одна с названием[^mynote].             |
|                                                   |                                                         |
| [^1]: Это текст первой ссылки.                    | [^1]: Это текст первой ссылки.                          |
|                                                   |                                                         |
| [^mynote]: Ссылки не обязательно нумеровать!      | [^mynote]: Ссылки не обязательно нумеровать!            |
| ```                                               |                                                         |
+---------------------------------------------------+---------------------------------------------------------+

```{=html}
<style type="text/css">
.heading-output {
  border-bottom: none;
  margin-top: 0;
  margin-bottom: 0;
}
</style>
```
В `quarto` для вставки формул используется код \LaTeX. Фрагменты формулы, которые на отдельной строке нужно вводить в двойных знаках доллара:

```markdown
$$Z(\lambda) = \int_{\mathcal{C_x}} dz g(z) e^{-\frac{f(x)}{\lambda}}$$
```

$$Z(\lambda) = \int_{\mathcal{C_x}} dz g(z) e^{-\frac{f(x)}{\lambda}}$$

Формулы внутри текста следует вводить в одинарных знаках доллара:

```markdown
Вот строка, в ней есть формула $\int_{\mathcal{C_x}} dz g(z) e^{-\frac{f(x)}{\lambda}}$
```

Вот строка, в ней есть формула $\int_{\mathcal{C_x}} dz g(z) e^{-\frac{f(x)}{\lambda}}$

## Вставка изображений и графиков

Стандартный синтаксис для вставки внешних изображений выглядит так `![заголовок](путь/к/изображению.png)`.

```markdown
![](images/photo_1.jpg)
```

![](images/09_04_photo_1.jpg) Размер вставялемого изображения можно изменить:

```markdown
![цветы в снегу](images/photo_1.jpg){width="80%"}
```

![цветы в снегу](images/09_04_photo_1.jpg){width="80%"}

Можно прижать к правому краю:

```markdown
![цветы в снегу](images/photo_1.jpg){width="80%" fig-align="right"}
```

![цветы в снегу](images/09_04_photo_1.jpg){width="80%" fig-align="right"}

Изображения можно комбинировать вместе. Для этого следует создать окружение при помощи `:::`. В фигурных скобках содержится ключ для ссылки на изображение, к которой потом можно обращаться и аргумент `layout-ncol="2"`. В фигурных скобках после конкретных изображений вставлены ключи для ссылки на отдельные подрисунки.

```markdown
::: {#fig-pictures layout-ncol="2"}
![цветы в снегу](images/photo_1.jpg){#fig-flowers}

![листья](images/photo_2.jpg){#fig-leafs}

Фотографии
:::
```

::: {#fig-pictures layout-ncol="2"}
![цветы в снегу](images/09_04_photo_1.jpg){#fig-flowers}

![листья](images/09_05_photo_2.jpg){#fig-leafs}

Фотографии
:::

Теперь мы можем сослаться на изображение @fig-pictures и отдельные подрисунки @fig-leafs и @fig-flowers. Как видно, ссылки оформляются при помощи знака собаки. Ключ рисунков должен начинатсья с `@fig-` (аналогичные правила действуют и для других объектов: `@sec-` для `@tbl-` для таблиц). Первое предложени данного абзаца сделано при помощи следующего фрагмента расширенной markdown-разметки:

```markdown
Теперь мы можем сослаться на изображение @fig-pictures и отдельные подрисунки @fig-leafs и @fig-flowers.
```

Для вставки изображения, которое генерируется при помощи кода, можно использовать фрагмент кода (см. раздел @sec-code_fragments ниже). Аргументы фрагмента кода добавляют при помощи `#|`, так что добавим аргументы `fig-cap`, который отвечает за подпись к графику, и аргумент `label`, который содержит ключ для ссылки:

````markdown
```{{r}}
#| fig-cap: "Наш код на R"
#| label: "fig-code_r"

library(tidyverse)
mtcars |> 
  ggplot(aes(mpg,drat))+
  geom_point()
```
````

```{r}
#| fig-cap: "Наш код на R"
#| label: "fig-code_r"
#| echo: false
#| warning: false
#| message: false

library(tidyverse)
mtcars |> 
  ggplot(aes(mpg,drat))+
  geom_point()
```

Попробуем сослаться на @fig-code_r (код ссылки такой же, как и выше: `@fig-code_r`).

## Вставка таблиц

Для вставки таблиц в `quarto` используется стандартный в markdown *pipe table syntax* (знак `|` часто называют pipe --- аналог конвеера). Подпись вставляют, поставив двоеточие. Выравнивание регулируется позицией двоеточия в разделителе заголовка и тела таблицы:

::: {layout-ncol="2"}

:::: {}

```markdown
| по умолчанию | слева | справа | по центру |
|--------------|:------|-------:|:---------:|
| йц           | ук    | ке     | нг        |
| фыв          | апр   | олд    | джэ       |
| я            | ч     | с      | м         |

: Таблицы в markdown
```

::::

:::: {}

| по умолчанию | слева | справа | по центру |
|--------------|:------|-------:|:---------:|
| йц           | ук    |     ке |    нг     |
| фыв          | апр   |    олд |    джэ    |
| я            | ч     |      с |     м     |

: Таблицы в markdown

::::
:::

Создавать такие таблицы руками не очень приятно, поэтому можно посмотреть на

-   [бесплатный Сайт Tables Generator](https://www.tablesgenerator.com/markdown_tables), позволяющий преобразовать в pipe table syntax таблицу из Excel/LibreOffice Calc
-   кроме того для вставки таблиц можно использовать [Visual Editor `quarto`](https://quarto.org/docs/visual-editor/content.html#editing-tables), который работает похожим образом.

Кроме того, после подписи (или на месте подписи) в фигурных скобках можно задать размеры столбцов:

```markdown
| слева | справа | по центру |
|-------|--------|-----------|
| ук    | ке     | нг        |
| апр   | олд    | джэ       |
| ч     | с      | м         |

: Таблица с разной шириной столбцов {tbl-colwidths="[3,1,5]"}
```

| слева | справа | по центру |
|-------|--------|-----------|
| ук    | ке     | нг        |
| апр   | олд    | джэ       |
| ч     | с      | м         |

: Таблица с разной шириной столбцов {tbl-colwidths="[3,1,5]"}

Ссылаться на таблицы можно аналогично как и на картинки при помощи хэштэга, а потом @tbl-our_table (код ссылки: `@tbl-our_table`):

```markdown
| слева | справа | по центру |
|-------|--------|-----------|
| яч    | см     | ит        |
| ъхз   | щшг    | нку       |
| л     | у      | ы         |

: Таблица с ссылкой {#tbl-our_table}
```

| слева | справа | по центру |
|-------|--------|-----------|
| яч    | см     | ит        |
| ъхз   | щшг    | нку       |
| л     | у      | ы         |

: Таблица со ссылкой {#tbl-our_table}

Таблицы, которые генерируются при помощи кода, имеют сходные аргументы, что и графики (`tbl-cap` и `label`):

````markdown
```{{r}}
#| tbl-cap: "Наша вторая таблица"
#| label: "tbl-our_second_table"

tibble(id = 1:26, let = letters[26:1])
```
````

```{r}
#| tbl-cap: "Наша вторая таблица"
#| label: "tbl-our_second_table"

tibble(id = 1:26, let = letters[26:1])
```

На эту таблицу можно сослаться стандартным образом: @tbl-our_second_table (код ссылки: `@tbl-our_second_table`).

Функционально markdown-таблицы и таблицы, которые порождены кодом, достаточно ограничены. Если есть нужда в создании таблиц с несколькими вложениями, сложным форматированием и, например, сносками, то можно обратиться к одному из следующих пакетов: 

- [`kableExtra`](https://haozhu233.github.io/kableExtra/)
- [`gt`](https://gt.rstudio.com/)
- [`DT`](https://rstudio.github.io/DT/)

## Ссылки на литературу

В `quarto` используется стандартная для \LaTeX/Pandoc система, в рамках котрой библиография оформляется в виде стандартизированного файла в одном из следующих форматов BibLaTeX (`.bib`) или BibTeX (`.bibtex`). Для того, чтобы все заработало создадим файл `reference.bib` со следующим содержанием:

```markdown
@article{nichols2007,
  title={What, if anything, is typology?},
  author={Nichols, Johanna},
  year={2007},
  volume={11},
  issue={1},
  pages={231--238},
  journal={Linguistic Typology},
  publisher={Walter de Gruyter}
}

@book{романова2016,
  title={Биология},
  author={Романова, Елена Михайловна and Шленкина, Татьяна Матвеевна and Шадыева, Людмила Алексеевна and Любомирова, Васелина Николаевна and Игнаткин, Денис Сергеевич and Шленкин, Константин Владимирович},
  year={2016},
  publisher={Федеральное государственное бюджетное образовательное учреждение высшего образования}
}
```

После этого следует добавить в `yaml`-шапку следующую строчку `bibliography: references.bib` и после этого можно ссылаться на источники одним из следующих способов.

+-----------------------------------------------------------+---------------------------------------------------------+
| markdown-разметка                                         | Результат                                               |
+===========================================================+=========================================================+
| ```markdown                                               |                                                         |
| В работе [@nichols2007, pp 10-15, также @романова2016]    | В работе [@nichols2007, pp 10-15; также @романова2016]  |
| ```                                                       |                                                         |
+-----------------------------------------------------------+---------------------------------------------------------+
| ```markdown                                               |                                                         |
| Джоханна Николс утвержадет ... [-@nichols2007]            | Джоханна Николс утвержадет ... [-@nichols2007]          |
| ```                                                       |                                                         |
+-----------------------------------------------------------+---------------------------------------------------------+

В результате получатся интерактивные ссылки, а в конце еще и автоматически сгенерируется список литературы. В технических работах принято ссылаться на работы при помощи номера (например, *в работе [1, 3]...*). Кроме того, автоматически стиль форматирования литературы может отличаться от требований, например, ГОСТа. Обе эти задачи решает особый стилевой файл с разрешением `.csl`, который следует поместить в папку с проектом, добавив при этом в `yaml`-iапку следующую строчку: `csl: ваш-файл.csl`. Один из вариантов `.csl` файла для оформления литературы по ГОСТу можно найти здесь.

Откуда же взять наполнение файла `references.bib`? Есть несколько путей. Во-первых в Google Scholar есть кнопка, позволяющая процитировать работу. При ее нажатии можно выбрать BibTex формат. Кроме того, Visual Editor `quarto` позволяет залезать в разные библиогрфические базы данных (Crossref, DataCite, PubMed), если в меню нажать Insert > Citation.

Также важно отметить, что сущестует пакет `bib2df`, который позволяет перегонять библиографический файл в таблицу и обратно, так что создание библиографии может стать обычной задачей заполнения таблички.

```{r}
#| eval: false

library(bib2df)
bib2df("references.bib")
```

```{r}
#| echo: false
#| message: false

library(bib2df)
bib2df("references.bib") |> 
  dplyr::filter(BIBTEXKEY %in% c("nichols2007", "романова2016"))
```

## Фрагменты кода {#sec-code_fragments}

В `quarto`-документ можно поместить фрагменты кода, которые во время компиляции будут исполнены. Обычно такие фрагменты начинаются с трех знаков машиночитаемого обратного апострофа (так на русский переводится английское Backtick --- название для символа, который в английской раскладке находится над буквой ё) и названия языка в фигурных скобках: ```` ```{r} ````.


## `yaml`-шапка

